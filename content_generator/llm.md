# LLM使用仕様書

## 概要
このドキュメントは、`functions/agent.py`で使用されているLLM（Large Language Model）の仕様と実装パターンをまとめたものです。

## 使用モデル
- **生成モデル**: `gemini-2.5-flash` (Vertex AI)
- **埋め込みモデル**: `text-embedding-004`
- **プロバイダー**: Google Cloud Vertex AI
- **リージョン**: `us-central1`

## 主要なプロンプト一覧

### 1. 動的タイトル生成プロンプト
**目的**: エピソードの内容に基づいて、セクションの動的なタイトルを生成

```python
title_prompt = f"""
以下のエピソードから、セクションのタイトルを生成してください。

【エピソード内容】
{episode_summary}

【タイトル生成のルール】
- 8文字以内の自然で親しみやすいタイトル
- 具体的な行動や場所を表現
- シンプルで分かりやすい表現
- 記号（*や-など）は使わない

【良い例】
- ブロックに夢中
- 公園を探検
- お絵かきタイム
- 水遊び大好き

【悪い例】
- **興味深い発見
- -成長の瞬間-
- ＊楽しい時間＊

タイトルのみを返してください（記号や装飾なし）：
"""
```

### 2. ベストショット選定プロンプト
**目的**: 期間内の全メディアから最も魅力的な「ベストショット」を複数選定

```python
selection_prompt = f"""
以下のメディア候補から、{child_name}の「今週のベストショット」として最も魅力的なものを2つ選んでください。

【選定基準】
1. 最も笑顔が素敵、または面白い表情
2. ほっこりする瞬間や楽しそうな様子
3. 変顔や驚いた表情など、印象的な瞬間
4. 動画も面白いものがあれば積極的に選ぶ（写真と動画の組み合わせが理想的）
5. 親が見て「この瞬間最高！」と思えるもの
6. 2つ選ぶ場合は、違うシーンや表情のものを選ぶ

【候補】
{candidates_text}

最も魅力的なメディア2つの番号をカンマ区切りで回答してください。
例: 3,7
必ず2つ選択してください。候補が少ない場合は重複しないよう1つだけ選んでください。
"""
```

### 3. 写真選定プロンプト
**目的**: テーマに最も適した写真を1つ選定

```python
selection_prompt = f"""
以下の写真候補から、「{theme['title']}」というテーマに最も適した写真を1つ必ず選んでください。
どの写真も候補にない場合でも、必ずいずれかの番号を選択してください。

選定基準：
1. テーマとの関連性が最も高い
2. 楽しそう、活発、印象的な瞬間を捉えている
3. {child_name}の表情や行動が良く分かる
4. テーマとの関連が薄くても、写真として魅力的である

【写真候補】
{candidates_text}

最も適した写真の番号（1〜{len(photo_candidates)}）のみを回答してください。
必ず1つの番号を選択し、それ以外は答えないでください。
"""
```

### 4. エピソード配分プロンプト
**目的**: 全エピソードを5つのセクションに重複なく最適配分

```python
distribution_prompt = f"""
あなたは{child_name}の週間ノートブックを作成するエディターです。
以下の{len(all_episodes_info)}個のエピソードから、5つのセクションに最適なエピソードを選んでください。

【重要な制約】
1. 同じエピソードを複数のセクションで使用しない
2. 似た内容のエピソードを連続させない
3. 異なるメディア（写真/動画）を各セクションに配置
4. 時系列や場所、活動の種類でバリエーションを持たせる

【セクション構成】
1. セクション1（大写真付き）: 最も印象的なエピソード
2. セクション2（テキストのみ）: 別の場面や活動
3. セクション3（小写真付き）: また違う活動や瞬間
4. セクション4（ベストショット）: 週の中で最も魅力的な写真/動画
5. セクション5（まとめ）: 全体を総括（複数エピソード使用可）

【利用可能なエピソード】
{episodes_summary}

【出力形式】
{{
    "section1": {{"episode_indices": [選択したエピソード番号], "reason": "選択理由"}},
    "section2": {{"episode_indices": [選択したエピソード番号], "reason": "選択理由"}},
    "section3": {{"episode_indices": [選択したエピソード番号], "reason": "選択理由"}},
    "section4": {{"episode_indices": [選択したエピソード番号], "reason": "選択理由"}},
    "section5": {{"episode_indices": [使用する全エピソード番号], "reason": "選択理由"}}
}}

必ず異なるエピソードを選び、内容の多様性を確保してください。
"""
```

### 5. まとめセクション用プロンプト
**目的**: 週全体を総括する150-200文字のまとめ文章を生成

```python
prompt = f"""
今週の{child_name}の様子を150-200文字でまとめてください。

【今週のエピソード】
{episodes_text}{custom_instructions}

【まとめのルール】
- 複数のエピソードから印象的な場面を選んで
- 「〜したり、〜したり」と具体的な行動を列挙
- 楽しかった瞬間を中心に
- 親しみやすい「です・ます」調

文章のみを出力（150-200文字）：
"""
```

### 6. 通常セクション用プロンプト
**目的**: 単一エピソードから100-150文字の描写文を生成

```python
prompt = f"""
以下のエピソードから、その場の様子を100-150文字で描写してください。

【テーマ】
「{theme['title']}」

【エピソード】
{episodes_text}{custom_instructions}

【描写のルール】
- このエピソードの事実のみを使用
- その場の様子や{child_name}の行動を具体的に
- 楽しい雰囲気で親しみやすく
- 成長や発達の評価は書かない
- 簡潔に、読みやすく

文章のみを出力（100-150文字）：
"""
```

### 7. キャプション生成プロンプト
**目的**: 写真・動画に15文字以内の自然なキャプションを生成

```python
caption_prompt = f"""
以下のエピソードから、{media_type}の内容を表現する自然なキャプションを15文字以内で生成してください。

【エピソード】
{caption_content}

【キャプション作成のルール】
- {media_type}に写っている具体的な行動、場面、状況を描写してください
- 成長や発達ではなく、その瞬間の楽しさや魅力を表現してください
- エピソードに出てくる具体的な要素（場所、物、行動）を活用してください
- 見る人がその場の雰囲気を感じられるような表現にしてください
- 明るく楽しい印象を与える言葉を選んでください

良い例：「ブランコで大はしゃぎ」「お祭りを満喫中」「積み木に夢中」「水遊びで大興奮」
避ける例：「成長を感じる」「発達の証」「○○ができるように」

キャプション：
"""
```

### 8. 段階的トピック生成プロンプト
**目的**: 前のトピックを考慮しながら新しいトピックを生成

```python
topic_prompt = f"""
あなたは{child_name}の週間ノートブックの編集者です。
セクション{i+1}のトピックを作成してください。

【セクション情報】
- セクションタイプ: {layout}
- テーマヒント: {theme.get('prompt_hint', '')}

【利用可能なエピソード】
{_format_episodes_for_llm(all_episodes, used_episode_ids)}

【既に作成済みのトピック】
{previous_topics_summary if previous_topics_summary else "まだトピックは作成されていません"}

【重要な制約】
1. 既に使用されたエピソードやメディアと重複しないこと
2. 前のトピックと異なる場面・活動を選ぶこと
3. 複数のエピソードを組み合わせて魅力的なストーリーを作ってもOK
4. {'写真/動画が必要' if layout != 'text_only' else 'テキストのみ（写真不要）'}

【出力形式】
{{
    "selected_episode_indices": [使用するエピソード番号のリスト],
    "abstract_theme": "このトピックの抽象的なテーマ（例：「お外で元気いっぱい」）",
    "title": "8文字以内のタイトル",
    "content": "100-150文字の内容",
    "selected_media_index": {'写真/動画のエピソード番号' if layout != 'text_only' else 'null'},
    "reasoning": "なぜこのエピソードを選んだか"
}}
"""
```

## LLM使用の特徴

### 1. 具体的で親しみやすい表現
- **文字数制限**: タイトルは8文字以内、キャプションは15文字以内
- **文体**: 「です・ます」調の親しみやすい表現
- **焦点**: 成長評価ではなく、その瞬間の楽しさや魅力を重視
- **具体性**: 抽象的な表現を避け、具体的な行動や場面を描写

### 2. 構造化された出力
- **JSON形式**: 複雑な選択結果はJSON形式で要求
- **明確な制約**: 選択基準、文字数、形式を明確に指定
- **例示**: 良い例・悪い例を提示して期待値を明確化
- **単一責任**: 各プロンプトは1つの明確な目的を持つ

### 3. エラーハンドリング
- **フォールバック**: LLM応答失敗時のデフォルト値設定
- **正規表現抽出**: JSON応答の柔軟な抽出処理
- **検証処理**: 生成内容の妥当性チェック
- **再試行**: 写真選定などで複数の戦略を順次試行

### 4. カスタマイズ機能
- **custom_tone**: ユーザー指定の文章スタイル反映
- **custom_focus**: 特定の観点への注目指示
- **子供の名前**: ニックネームの一貫した使用（「ちゃん」「くん」付け）
- **動的調整**: エピソード数に応じたプロンプト調整

## 実装パターン

### 1. プロンプト構成
```python
# 基本構造
prompt = f"""
[タスクの説明]

【入力データ】
{input_data}

【ルール/制約】
- ルール1
- ルール2

【出力形式】
[期待する出力の説明]
"""
```

### 2. LLM呼び出しパターン
```python
try:
    # モデルの初期化
    initialize_vertex_ai()
    model = GenerativeModel(MODEL_NAME)
    
    # プロンプト生成
    prompt = generate_prompt(...)
    
    # LLM呼び出し
    response = model.generate_content(prompt)
    result = response.text.strip()
    
    # 後処理（必要に応じて）
    result = post_process(result)
    
except Exception as e:
    logger.error(f"Error in LLM call: {str(e)}")
    # フォールバック処理
    return default_value
```

### 3. JSON応答の処理
```python
# JSON抽出パターン
import re
json_match = re.search(r"```json\s*(.*?)\s*```", response_text, re.DOTALL)
if json_match:
    response_text = json_match.group(1)
else:
    json_match = re.search(r"\{.*\}", response_text, re.DOTALL)
    if json_match:
        response_text = json_match.group(0)

# パース
try:
    result = json.loads(response_text)
except json.JSONDecodeError:
    # エラーハンドリング
    pass
```

## 最適化のポイント

### 1. リソース管理
- **遅延初期化**: グローバル変数でモデルインスタンスを管理
- **接続再利用**: Vertex AIクライアントの再利用
- **バッチ処理**: 複数の処理をまとめて実行

### 2. パフォーマンス
- **並列処理**: 独立したタスクは並行実行可能
- **キャッシュ**: Firestoreからの読み取り最小化
- **早期終了**: 条件を満たしたら即座に処理終了

### 3. 品質管理
- **プロンプトテンプレート**: 一貫性のある構造
- **検証ロジック**: 生成結果の妥当性確認
- **ログ記録**: デバッグ用の詳細なログ出力

## 今後の改善ポイント

1. **プロンプトの最適化**
   - Few-shot learningの活用
   - Chain of Thoughtの導入
   - より詳細な例示の追加

2. **エラーハンドリングの強化**
   - リトライロジックの改善
   - タイムアウト処理の追加
   - より詳細なエラー分類

3. **コスト最適化**
   - プロンプトトークン数の削減
   - キャッシュ戦略の改善
   - モデル選択の最適化

4. **品質向上**
   - A/Bテストによるプロンプト改善
   - ユーザーフィードバックの収集
   - 生成結果の品質メトリクス導入