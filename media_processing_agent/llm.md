# LLM使用仕様

## 概要
このシステムでは、Google Cloud の Vertex AI を通じて Gemini 2.5 Flash モデルを使用し、子供の写真や動画から具体的なシーンや行動を分析します。

## 使用モデル
- **モデル名**: `gemini-2.5-flash`
- **プロバイダ**: Google Cloud Vertex AI
- **用途**: マルチモーダル分析（画像・動画の内容理解とテキスト生成）

## 主要な分析機能

### 1. 客観的事実の抽出 (objective_analyzer)
**目的**: メディアファイルから観察可能な事実を抽出

**プロンプトの重点**:
- 子供が「何をしているか」を具体的に特定
- その場の状況や環境を詳しく描写
- 子供の表情や動作を客観的に記録
- 成長や発達の推測は行わない

**出力形式**:
```json
{
    "scene_description": "シーン全体の描写",
    "child_actions": ["具体的な行動のリスト"],
    "child_expressions": ["観察できる表情や感情表現"],
    "objects_and_items": ["使用している物のリスト"],
    "environment_details": ["周囲の詳細"],
    "body_posture": ["姿勢や体の位置"],
    "spoken_or_sounds": ["聞こえる言葉や音"],
    "clothing_and_appearance": ["服装や身に着けているもの"]
}
```

### 2. 分析視点の決定 (perspective_determiner)
**目的**: 抽出された事実から、分析すべき視点を決定

**分析視点の種類**:
- **行動の特定**: 子供の具体的な動作や行為
- **シーンの背景**: 場所、状況、環境
- **表情や感情の瞬間**: その時の気持ちや反応
- **物や人との関わり**: 使用している物、一緒にいる人

**制約**:
- 視点数は最大4つまで
- 実際に観察された内容に基づく視点のみ選択
- 各視点は重複しないように独立した観点から選択

### 3. 詳細分析 (dynamic_multi_analyzer)
**目的**: 各視点から具体的なシーン描写を生成

**描写の指針**:
1. 具体的な行動の記録
2. シーンの情景描写
3. 表情や反応の観察
4. 楽しい瞬間の強調
5. 検索しやすいタグ生成

**出力形式**:
```json
{
    "perspective_type": "視点タイプ",
    "title": "15文字以内のタイトル",
    "summary": "100文字程度の要約",
    "content": "詳細な描写",
    "scene_keywords": ["キーワード"],
    "vector_tags": ["検索用タグ（10-20文字のフレーズ）"]
}
```

### 4. 感情的タイトル生成 (generate_emotional_title)
**目的**: タイムライン表示用の魅力的なタイトル生成

**タイトルの条件**:
- 15〜20文字程度
- 具体的な行動やシーンが分かる表現
- 親しみやすく、ほっこりする表現
- 最後に内容に合った絵文字を1つ付ける

**良い例**:
- 「積み木に夢中な午後🧱」
- 「お祭りを楽しむ笑顔🎆」
- 「おやつタイムの真剣顔🍪」
- 「水遊びで大はしゃぎ💦」

## 技術的な実装詳細

### メディア処理
- Firebase Storage URLを`gs://`形式に変換してアクセス性向上
- MIMEタイプを拡張子から自動判定
- 画像形式: JPEG, PNG, GIF, WebP, BMP
- 動画形式: MP4, AVI, MOV, WebM, MKV

### エラーハンドリング
1. **JSON解析エラー**: 正規表現でJSON部分を抽出
2. **URLアクセスエラー**: 具体的な解決策を提示
   - Firebase StorageのCORS設定確認
   - Service Accountの権限確認
   - Cloud Storageバケットの権限確認

### レスポンス処理
- Markdownコードブロック内のJSONを抽出
- 空のレスポンスチェック
- 構造化されたエラーメッセージの返却

## 設計方針

### 重要な制約
- **成長・発達の評価は行わない**
- **「できるようになった」などの断定的表現を避ける**
- **その瞬間の楽しさや魅力を中心に描写**

### フォーカスポイント
1. 具体的な行動とシーンの記録
2. 親が見て「この瞬間素敵だな」と思える表現
3. 後から検索しやすいタグ付け
4. 客観的事実に基づく分析

## 環境設定
- **プロジェクトID**: 環境変数 `GOOGLE_CLOUD_PROJECT`
- **ロケーション**: 環境変数 `GOOGLE_CLOUD_LOCATION` (デフォルト: us-central1)
- **認証**: Vertex AI のデフォルト認証を使用